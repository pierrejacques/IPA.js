"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var _=require("lodash"),___default=_interopDefault(_),classCallCheck=function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),toConsumableArray=function(e){if(Array.isArray(e)){for(var n=0,t=Array(e.length);n<e.length;n++)t[n]=e[n];return t}return Array.from(e)},_cache_=Symbol("cache"),Cache=function(){function e(){classCallCheck(this,e),this[_cache_]=new Map}return createClass(e,[{key:"push",value:function(e,n){_.isArray(this[_cache_].get(e))||this[_cache_].set(e,[]),this[_cache_].get(e).push(n)}},{key:"set",value:function(e,n){this[_cache_].set(e,n)}},{key:"get",value:function(e){return this[_cache_].get(e)}},{key:"forEach",value:function(e){this[_cache_].forEach(e)}},{key:"reset",value:function(){this[_cache_].clear()}},{key:"digest",value:function(e){var n=this;this.reset(),Object.keys(e).forEach(function(t){n.set(t,e[t])})}}]),e}(),cache=new Cache,_core_=Symbol("IPA_core"),fixLength=function(e,n){var t=n.target,r=n.mocker;t.length>e?t.splice(e):t.push.apply(t,toConsumableArray(_.times(e-t.length,r)))},strategies={most:function(e){var n=e.map(function(e){return e.target.length}),t=new Map;return n.forEach(function(e){void 0===t.get(e)&&t.set(e,0),t.set(e,t.get(e)+1)}),[].concat(toConsumableArray(t)).sort(function(e,n){return e[1]<n[1]}).map(function(e){return e[0]})[0]},shortest:function(e){return Math.min.apply(Math,toConsumableArray(e.map(function(e){return e.target.length})))},longest:function(e){return Math.max.apply(Math,toConsumableArray(e.map(function(e){return e.target.length})))},average:function(e){var n=_.mean(e.map(function(e){return e.target.length}));return Math.ceil(n)}},fixer=function(e){var n=strategies[e]||strategies.shortest;cache.forEach(function(e,t){var r=_.isNumber(t)?t:n(e);e.forEach(function(e){fixLength(r,e)})})};Object.assign(fixer,strategies);var checkLength=function(){var e=!0;return cache.forEach(function(n,t){e=_.isNumber(t)?e&&0===n.filter(function(e){return e!==t}).length:e&&_.min(n)===_.max(n)}),e},g=["check","guarantee","mock",_core_],b=["strategy"],createProxy=function(e){var n={};return g.forEach(function(t){Object.defineProperty(n,t,{get:function(){return e()[t]}})}),b.forEach(function(t){Object.defineProperty(n,t,{set:function(){return e()[t]},get:function(){return e()[t]}})}),n},dict=["ad","aliqua","amet","anim","aute","cillum","commodo","culpa","do","dolor","duis","elit","enim","esse","est","et","ex","fugiat","id","in","ipsum","irure","labore","Lorem","magna","minim","mollit","nisi","non","nulla","officia","pariatur","quis","sint","sit","sunt","tempor","ut","velit","veniam"],randStr=function(){return dict[_.random(0,dict.length-1)]},S=function(e,n,t,r){return function(){return{check:e,guarantee:function(r,i){return e(r)?r:i?t:n(r)},mock:function(e){return e?t:r()}}}},presets=new Map([[String,S(_.isString,_.toString,"",randStr)],[Number,S(_.isNumber,function(e){var n=_.toNumber(e);return!isNaN(n)&&isFinite(n)?n:0},0,function(){return _.random(0,100)})],[Boolean,S(_.isBoolean,function(e){return!!e},!1,function(){return!_.random(0,1)})],[Array,S(_.isArray,_.toArray,[],function(){return[]})],[Object,S(_.isPlainObject,function(){return{}},{},function(){return{}})]]),bypass={check:function(){return!0},guarantee:function(e){return e},mock:function(){}},functionCompiler={condition:_.isFunction,execute:function(e){return presets.has(e)?presets.get(e):function(n){return{check:e(n).check||bypass.check,guarantee:e(n).guarantee||bypass.guarantee,mock:e(n).mock||bypass.mock}}}},ipaCompiler={condition:function(e){return!(!e||!e[_core_])},execute:function(e){return function(){return e[_core_]}}},arrayCompiler={condition:function(e){return _.isArray(e)},execute:function(e){var n=e[1];if(void 0!==n&&!_.isNumber(n)&&!_.isString(n))throw new Error("compile failed: the 2nd parameter for array can only be String or Number");return function(t){var r=t(e[0]);return{check:function(e){if(!_.isArray(e))return!1;var t=!0;return e.forEach(function(e){t=t&&r.check(e)}),void 0!==n&&cache.push(n,e.length),t},guarantee:function(e,t){var i=_.isArray(e)?e:[];return i.forEach(function(e,n){i[n]=r.guarantee(e,t)}),void 0!==n&&cache.push(n,{target:i,mocker:function(){return r.guarantee(void 0,t)}}),i},mock:function(e){var t=e?0:_.random(0,10);return _.isNumber(n)&&(t=n),_.isString(n)&&(_.isNumber(cache.get(n))?t=cache.get(n):cache.set(n,t)),_.times(t,function(){return r.mock(e)})}}}}},booleanCompiler={condition:_.isBoolean,execute:function(e){return function(){return{check:_.isBoolean,guarantee:function(n){return _.isBoolean(n)?n:e},mock:function(n){return n?e:!_.random(0,1)}}}}},nullCompiler={condition:function(e){return null===e},execute:function(){return function(){return{check:function(e){return void 0!==e},guarantee:function(e){return void 0===e?null:e},mock:function(){return null}}}}},numberCompiler={condition:_.isNumber,execute:function(e){return function(){return{check:_.isNumber,guarantee:function(n){return _.isNumber(n)?n:e},mock:function(n){return n?e:_.random(0,100)}}}}},objectCompiler={condition:function(e){return _.isPlainObject(e)&&!e[_core_]},execute:function(e){return function(n){var t={};return Object.keys(e).forEach(function(r){t[r]=n(e[r])}),{check:function(e){if(!_.isPlainObject(e))return!1;var n=!0;return Object.keys(t).forEach(function(r){n=n&&t[r].check(e[r])}),n},guarantee:function(e,n){var r=_.isPlainObject(e)?e:{};return Object.keys(t).forEach(function(e){r[e]=t[e].guarantee(r[e],n)}),r},mock:function(e){var n={};return Object.keys(t).forEach(function(r){n[r]=t[r].mock(e)}),n}}}}},undefinedCompiler={condition:function(e){return void 0===e},execute:function(){return function(){return{check:function(){return!0},guarantee:function(e){return e},mock:function(){}}}}},stringCompiler={condition:_.isString,execute:function(e){return function(){return{check:_.isString,guarantee:function(n){return _.isString(n)?n:e},mock:function(n){return n?e:randStr()}}}}},compilers=[functionCompiler,ipaCompiler,arrayCompiler,booleanCompiler,nullCompiler,numberCompiler,objectCompiler,undefinedCompiler,stringCompiler],compile=function e(n){for(var t=void 0,r=0;r<compilers.length;r++)if(compilers[r].condition(n)){t=compilers[r].execute(n);break}if(!t)throw new Error("compile error: failed to recognize pattern "+JSON.stringify(n));return t(e)},isProductionEnv=!1,_strat_=Symbol("strategy"),IPA=function(){function e(n){classCallCheck(this,e),this[_core_]=compile(n),this[_strat_]="shortest"}return createClass(e,[{key:"check",value:function(e){var n=this[_core_].check(e)&&checkLength();return cache.reset(),n}},{key:"guarantee",value:function(e){var n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],t=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=n?___default.cloneDeep(e):e,i=this[_core_].guarantee(r,t);return fixer(this.strategy),cache.reset(),i}},{key:"mock",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:isProductionEnv,t=e;if(!___default.isPlainObject(t)){if(!isProductionEnv)throw new Error("mocking setting should be a plain object");t={}}cache.digest(t);var r=this[_core_].mock(n);return cache.reset(),r}},{key:"strategy",set:function(e){if(fixer[e])this[_strat_]=e;else if(!isProductionEnv)throw new Error('in IPA strategy setter: invalid strategy "'+e+'"')},get:function(){return this[_strat_]}}]),e}(),instances=new Map;IPA.inject=function(e,n){if(instances.has(e)&&!isProductionEnv)throw new Error("in inject: reassign to global IPA instance is not arrowed");instances.set(e,new IPA(n))},IPA.getInstance=function(e){var n=null;return createProxy(function(){if(n)return n;if(void 0===(n=instances.get(e)))throw new Error("in getInstance: IPA instance called before injected");return n})},IPA.$compile=compile,IPA.install=function(e){var n=e;n.prototype.$ipa=IPA.getInstance,n.prototype.$brew=IPA.$compile},Object.defineProperty(IPA,"isProductionEnv",{set:function(e){isProductionEnv=!!e},get:function(){return isProductionEnv}}),module.exports=IPA;
