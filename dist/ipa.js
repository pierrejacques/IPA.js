"use strict";function _interopDefault(n){return n&&"object"==typeof n&&"default"in n?n.default:n}var _=require("lodash"),___default=_interopDefault(_),classCallCheck=function(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")},createClass=function(){function n(n,e){for(var t=0;t<e.length;t++){var r=e[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(n,r.key,r)}}return function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}}(),toConsumableArray=function(n){if(Array.isArray(n)){for(var e=0,t=Array(n.length);e<n.length;e++)t[e]=n[e];return t}return Array.from(n)},_cache_=Symbol("cache"),Cache=function(){function n(){classCallCheck(this,n),this[_cache_]=new Map}return createClass(n,[{key:"push",value:function(n,e){_.isArray(this[_cache_].get(n))||this[_cache_].set(n,[]),this[_cache_].get(n).push(e)}},{key:"set",value:function(n,e){this[_cache_].set(n,e)}},{key:"get",value:function(n){return this[_cache_].get(n)}},{key:"forEach",value:function(n){this[_cache_].forEach(n)}},{key:"reset",value:function(){this[_cache_].clear()}},{key:"digest",value:function(n){var e=this;this.reset(),Object.keys(n).forEach(function(t){e.set(t,n[t])})}}]),n}(),cache=new Cache,_core_=Symbol("IPA_core"),fixLength=function(n,e){var t=e.target,r=e.mocker;t.length>n?t.splice(n):t.push.apply(t,toConsumableArray(_.times(n-t.length,r)))},strategies={most:function(n){var e=n.map(function(n){return n.target.length}),t=new Map;return e.forEach(function(n){void 0===t.get(n)&&t.set(n,0),t.set(n,t.get(n)+1)}),[].concat(toConsumableArray(t)).sort(function(n,e){return n[1]<e[1]}).map(function(n){return n[0]})[0]},shortest:function(n){return Math.min.apply(Math,toConsumableArray(n.map(function(n){return n.target.length})))},longest:function(n){return Math.max.apply(Math,toConsumableArray(n.map(function(n){return n.target.length})))},average:function(n){var e=_.mean(n.map(function(n){return n.target.length}));return Math.ceil(e)}},fixer=function(n){var e=strategies[n]||strategies.shortest;cache.forEach(function(n,t){var r=_.isNumber(t)?t:e(n);n.forEach(function(n){fixLength(r,n)})})};Object.assign(fixer,strategies);var checkLength=function(){var n=!0;return cache.forEach(function(e,t){n=_.isNumber(t)?n&&0===e.filter(function(n){return n!==t}).length:n&&_.min(e)===_.max(e)}),n},g=["check","guarantee","mock",_core_],b=["strategy"],createProxy=function(n){var e={};return g.forEach(function(t){Object.defineProperty(e,t,{get:function(){return n()[t]}})}),b.forEach(function(t){Object.defineProperty(e,t,{set:function(){return n()[t]},get:function(){return n()[t]}})}),e},dict=["ad","aliqua","amet","anim","aute","cillum","commodo","culpa","do","dolor","duis","elit","enim","esse","est","et","ex","fugiat","id","in","ipsum","irure","labore","Lorem","magna","minim","mollit","nisi","non","nulla","officia","pariatur","quis","sint","sit","sunt","tempor","ut","velit","veniam"],randStr=function(){return dict[_.random(0,dict.length-1)]},S=function(n,e,t,r){return function(){return{check:n,guarantee:function(r,c){return n(r)?r:c?t:e(r)},mock:function(n){return n?t:r()}}}},presets=new Map([[String,S(_.isString,_.toString,"",randStr)],[Number,S(_.isNumber,function(n){var e=_.toNumber(n);return!isNaN(e)&&isFinite(e)?e:0},0,function(){return _.random(0,100)})],[Boolean,S(_.isBoolean,function(n){return!!n},!1,function(){return!_.random(0,1)})],[Array,S(_.isArray,_.toArray,[],function(){return[]})],[Object,S(_.isPlainObject,function(){return{}},{},function(){return{}})]]),bypass={check:function(){return!0},guarantee:function(n){return n},mock:function(){}},functionCompiler={condition:_.isFunction,execute:function(n){return presets.has(n)?presets.get(n):function(e){return{check:n(e).check||bypass.check,guarantee:n(e).guarantee||bypass.guarantee,mock:n(e).mock||bypass.mock}}}},ipaCompiler={condition:function(n){return!(!n||!n[_core_])},execute:function(n){return function(){return n[_core_]}}},arrayCompiler={condition:function(n){return _.isArray(n)},execute:function(n){var e=n[1];if(void 0!==e&&!_.isNumber(e)&&!_.isString(e))throw new Error("compile failed: the 2nd parameter for array can only be String or Number");return function(t){var r=t(n[0]);return{check:function(n){return!!_.isArray(n)&&(void 0!==e&&cache.push(e,n.length),!n.filter(function(n){return!r.check(n)}).length)},guarantee:function(n,t){var c=_.isArray(n)?n:[];return c.forEach(function(n,e){c[e]=r.guarantee(n,t)}),void 0!==e&&cache.push(e,{target:c,mocker:function(){return r.guarantee(void 0,t)}}),c},mock:function(n){var t=n?0:_.random(0,10);return _.isNumber(e)&&(t=e),_.isString(e)&&(_.isNumber(cache.get(e))?t=cache.get(e):cache.set(e,t)),_.times(t,function(){return r.mock(n)})}}}}},booleanCompiler={condition:_.isBoolean,execute:function(n){return function(){return{check:_.isBoolean,guarantee:function(e){return _.isBoolean(e)?e:n},mock:function(e){return e?n:!_.random(0,1)}}}}},nullCompiler={condition:function(n){return null===n},execute:function(){return function(){return{check:function(n){return void 0!==n},guarantee:function(n){return void 0===n?null:n},mock:function(){return null}}}}},numberCompiler={condition:_.isNumber,execute:function(n){return function(){return{check:_.isNumber,guarantee:function(e){return _.isNumber(e)?e:n},mock:function(e){return e?n:_.random(0,100)}}}}},objectCompiler={condition:function(n){return _.isPlainObject(n)&&!n[_core_]},execute:function(n){return function(e){var t={};return Object.keys(n).forEach(function(r){t[r]=e(n[r])}),{check:function(n){if(!_.isPlainObject(n))return!1;var e=!0;return Object.keys(t).forEach(function(r){e=e&&t[r].check(n[r])}),e},guarantee:function(n,e){var r=_.isPlainObject(n)?n:{};return Object.keys(t).forEach(function(n){r[n]=t[n].guarantee(r[n],e)}),r},mock:function(n){var e={};return Object.keys(t).forEach(function(r){e[r]=t[r].mock(n)}),e}}}}},undefinedCompiler={condition:function(n){return void 0===n},execute:function(){return function(){return{check:function(){return!0},guarantee:function(n){return n},mock:function(){}}}}},stringCompiler={condition:_.isString,execute:function(n){return function(){return{check:_.isString,guarantee:function(e){return _.isString(e)?e:n},mock:function(e){return e?n:randStr()}}}}},compilers=[functionCompiler,ipaCompiler,arrayCompiler,booleanCompiler,nullCompiler,numberCompiler,objectCompiler,undefinedCompiler,stringCompiler],compile=function n(e){for(var t=void 0,r=0;r<compilers.length;r++)if(compilers[r].condition(e)){t=compilers[r].execute(e);break}if(!t)throw new Error("compile error: failed to recognize pattern "+JSON.stringify(e));return t(n)},asClass=function(n){for(var e=arguments.length,t=Array(e>1?e-1:0),r=1;r<e;r++)t[r-1]=arguments[r];if(!_.isFunction(n))throw new Error('function "asClass" only accept constructor function as 1st parameter');try{new(Function.prototype.bind.apply(n,[null].concat(t)))}catch(n){throw new Error('in function "as Class", class(1st param) must match with the params(the rest params)')}return function(){return{check:function(e){return e instanceof n},guarantee:function(e){return e instanceof n?e:new(Function.prototype.bind.apply(n,[null].concat(t)))},mock:function(){return new(Function.prototype.bind.apply(n,[null].concat(t)))}}}},Dict=function(n){return function(e){var t=e(n);return{check:function(n){if(!_.isPlainObject(n))return!1;var e=!0;return Object.values(n).forEach(function(n){e=e&&t.check(n)}),e},guarantee:function(n,e){var r=n;return _.isPlainObject(r)?(Object.keys(r).forEach(function(n){r[n]=t.guarantee(r[n],e)}),r):{}},mock:function(n){var e={};return _.range(0,n?0:_.random(1,10)).forEach(function(){e[randStr()]=t.mock(n)}),e}}}},Integer=function(){return{check:function(n){return _.isInteger(n)},guarantee:function(n,e){return _.isInteger(n)?n:e?0:_.toInteger(n)},mock:function(n){return n?0:_.random(0,1e3)}}},or=function(){for(var n=arguments.length,e=Array(n),t=0;t<n;t++)e[t]=arguments[t];if(0===e.length)throw new Error('function "or" requires at least 1 parameter');return function(n){var t=e.map(function(e){return n(e)});return{check:function(n){var e=!1;return t.forEach(function(t){e=e||t.check(n)}),e},guarantee:function(n,e){return this.check(n)?n:t[0].guarantee(n,e)},mock:function(n){return t[0].mock(n)}}}},Range=function(n,e){var t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!_.isNumber(n)||!_.isNumber(e))throw new Error('function "Range" only accept Number as 1st & 2nd parameters');if(n>e)throw new Error('in function "Range", min(1st param) must be no larger than max(2st param)');return function(r){var c=r(Number);return{check:function(t){return _.isNumber(t)&&t>=n&&t<=e},guarantee:function(t,r){var o=c.guarantee(t,r);return o<n?n:o>e?e:o},mock:function(r){return r?n:_.random(n,e,t)}}}},Each=function(n){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!_.isArray(n))throw new Error('function "Each" only accepts array as parameter');return function(t){var r=n.map(function(n){return t(n)});return{check:function(t){if(!_.isArray(t))return!1;var c=!e||t.length===n.length;return r.forEach(function(n,e){c=c&&n.check(t[e])}),c},guarantee:function(n,t){var c=_.isArray(n)?n:[];return r.forEach(function(n,e){c[e]=n.guarantee(c[e],t)}),e&&c.splice(r.length),c},mock:function(n){return r.map(function(e){return e.mock(n)})}}}},From=function(){for(var n=arguments.length,e=Array(n),t=0;t<n;t++)e[t]=arguments[t];var r=e.length,c=function(){var n=e[_.random(0,r-1)];return _.cloneDeep(n)};return function(){return{check:function(n){for(var t=0;t<r;t++)if(_.isEqual(e[t],n))return!0;return!1},guarantee:function(n,t){return this.check(n)?n:t?e[0]:c()},mock:function(n){return n?_.cloneDeep(e[0]):c()}}}},publicExposed={asClass:asClass,Dict:Dict,Integer:Integer,or:or,Range:Range,Each:Each,From:From},isProductionEnv=!1,_strat_=Symbol("strategy"),IPA=function(){function n(e){classCallCheck(this,n),this[_core_]=compile(e),this[_strat_]="shortest"}return createClass(n,[{key:"check",value:function(n){var e=this[_core_].check(n)&&checkLength();return cache.reset(),e}},{key:"guarantee",value:function(n){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],t=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=e?___default.cloneDeep(n):n,c=this[_core_].guarantee(r,t);return fixer(this.strategy),cache.reset(),c}},{key:"mock",value:function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:isProductionEnv,t=n;if(!___default.isPlainObject(t)){if(!isProductionEnv)throw new Error("mocking setting should be a plain object");t={}}cache.digest(t);var r=this[_core_].mock(e);return cache.reset(),r}},{key:"strategy",set:function(n){if(fixer[n])this[_strat_]=n;else if(!isProductionEnv)throw new Error('in IPA strategy setter: invalid strategy "'+n+'"')},get:function(){return this[_strat_]}}]),n}(),instances=new Map;IPA.inject=function(n,e){if(instances.has(n)&&!isProductionEnv)throw new Error("in inject: reassign to global IPA instance is not arrowed");instances.set(n,new IPA(e))},IPA.getInstance=function(n){var e=null;return createProxy(function(){if(e)return e;if(void 0===(e=instances.get(n)))throw new Error("in getInstance: IPA instance called before injected");return e})},IPA.$compile=compile,IPA.install=function(n){var e=n;e.prototype.$ipa=IPA.getInstance,e.prototype.$brew=IPA.$compile},Object.assign(IPA,publicExposed),Object.defineProperty(IPA,"isProductionEnv",{set:function(n){isProductionEnv=!!n},get:function(){return isProductionEnv}}),module.exports=IPA;
